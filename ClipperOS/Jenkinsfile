pipeline {
    agent any // Define o agente que irá executar o pipeline
    stages {
        stage('Setup Infisical') {
            steps {
                script {
                    node {
                        withInfisical(
                            configuration: [
                                infisicalCredentialId: 'Infisical',
                                infisicalEnvironmentSlug: 'prod',
                                infisicalProjectSlug: 'devops',
                                infisicalUrl: 'https://app.infisical.com'
                            ],
                            infisicalSecrets: [
                                infisicalSecret(
                                    includeImports: true,
                                    path: '/',
                                    secretValues: [
                                        [infisicalKey: 'POSTGRESDBLINK'],
                                        [infisicalKey: 'POSTGRESDBUSER'],
                                        [infisicalKey: 'POSTGRESDBPASS'],
                                        [infisicalKey: 'THIS_KEY_MIGHT_NOT_EXIST', isRequired: false]
                                    ]
                                )
                            ]
                        ) {
                            // Exibe as variáveis de ambiente para depuração
                            sh "printenv"
                            env.POSTGRESDBLINK = "${env.POSTGRESDBLINK}"
                            env.POSTGRESDBUSER = "${env.POSTGRESDBUSER}"
                            env.POSTGRESDBPASS = "${env.POSTGRESDBPASS}"
                        }
                    }
                }
            }
        }
        stage('Build Docker Image') {
            steps {
                script {
                    // Construa a imagem Docker
                    sh 'docker build -t clipperos:latest .'
                }
            }
        }
       stage('Start Existing Docker Containers') {
           steps {
               script {
                   // Inicie os contêineres Docker existentes
                   sh 'docker start mongodb'
                   sh 'docker start pgadmin'
                   sh 'docker start postgres-db'
                   sh 'docker start jenkins'
                   sh 'docker start infisical'
               }
           }
       }

    }
}
